---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: keep-tecdsa-1
  namespace: default
  labels:
    keel.sh/policy: all
    app: keep
    type: tecdsa
spec:
  replicas: 1
  selector:
    matchLabels:
      app: keep
      type: tecdsa
      id: '1'
  serviceName: keep-tecdsa-1
  volumeClaimTemplates:
    - metadata:
        name: keep-tecdsa-data
      spec:
        accessModes: [ReadWriteOnce]
        resources:
          requests:
            storage: 512Mi
    - metadata:
        name: keep-tecdsa-config
      spec:
        accessModes: [ReadWriteOnce]
        resources:
          requests:
            storage: 5Mi
  template:
    metadata:
      labels:
        app: keep
        type: tecdsa
        id: '1'
    spec:
      containers:
        - name: keep-tecdsa
          image: gcr.io/keep-dev-fe24/keep-tecdsa
          imagePullPolicy: Always
          ports:
            - containerPort: 3919
          env:
            - name: KEEP_ETHEREUM_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: eth-account-passphrases
                  key: account-1
            - name: LOG_LEVEL
              value: 'keep*=debug tss-lib=warning'
          volumeMounts:
            - name: keep-tecdsa-config
              mountPath: /mnt/keep-tecdsa/config
            - name: keep-tecdsa-data
              mountPath: /mnt/keep-tecdsa/data
            - name: eth-account-keyfile
              mountPath: /mnt/keep-tecdsa/keyfile
          command:
            [
              'keep-tecdsa',
              '-config',
              '/mnt/keep-tecdsa/config/keep-tecdsa-config.toml',
              'start',
            ]
      initContainers:
        - name: initcontainer-provision-keep-tecdsa
          image: gcr.io/keep-dev-fe24/initcontainer-provision-keep-tecdsa
          imagePullPolicy: Always
          env:
            - name: ETH_RPC_URL
              valueFrom:
                configMapKeyRef:
                  name: eth-network-internal
                  key: rpc-url
            - name: ETH_WS_URL
              valueFrom:
                configMapKeyRef:
                  name: eth-network-internal
                  key: ws-url
            - name: ETH_NETWORK_ID
              valueFrom:
                configMapKeyRef:
                  name: eth-network-internal
                  key: network-id
            - name: CONTRACT_OWNER_ETH_ACCOUNT_ADDRESS
              valueFrom:
                configMapKeyRef:
                  name: eth-network-internal
                  key: contract-owner-eth-account-address
            - name: CONTRACT_OWNER_ETH_ACCOUNT_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: eth-network-internal
                  key: contract-owner-eth-account-private-key
            - name: KEEP_TECDSA_ETH_KEYFILE_PATH
              value: /mnt/keep-tecdsa/keyfile/account-1-keyfile
            - name: KEEP_TECDSA_PEERS
              value: /ip4/10.102.100.34/tcp/3919/ipfs/16Uiu2HAmCcfVpHwfBKNFbQuhvGuFXHVLQ65gB4sJm7HyrcZuLttH
            - name: KEEP_TECDSA_ANNOUNCED_ADDRESSES
              value: ''
            - name: KEEP_TECDSA_PORT
              value: '3919'
            - name: KEEP_DATA_DIR
              value: /mnt/keep-tecdsa/data
            - name: TBTC_SYSTEM_ADDRESS
              value: '0x6E4494F5083Cb46269E84A405857636F63Dd5D17' # Shall we extract this property to a configmap?
          volumeMounts:
            - name: keep-tecdsa-config
              mountPath: /mnt/keep-tecdsa/config
            - name: eth-account-keyfile
              mountPath: /mnt/keep-tecdsa/keyfile
          command: ['node', '/tmp/provision-keep-tecdsa.js']
      volumes:
        - name: keep-tecdsa-config
          persistentVolumeClaim:
            claimName: keep-tecdsa-config
        - name: keep-tecdsa-data
          persistentVolumeClaim:
            claimName: keep-tecdsa-data
        - name: eth-account-keyfile
          configMap:
            name: eth-account-info
            items:
              - key: account-1-keyfile
                path: account-1-keyfile
